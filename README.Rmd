---
title: "README"
output: pdf_document
date: "2023-08-17"
echo = FALSE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

## Summarized workflow

1.  `burn_in.slim` from the terminal\
2.  `wrapper.sh` in the directory you wish the output to be stored\
3.  `sort_output.sh` to parse full runs from incomplete runs of the model\
4.  `join_data.R` to collate all run data into tidier files\
5.  `plots.R` to further tidy data and generate plots

## Running the model

Included in this program are two SLiM models for simulating the spread of a chromosomal inversion. The SLiM files are run by shell scripts designed to run many instances of the SLiM model in parallel and output files to a directory. The two SLiM models differ in the traits the inversion has. There is a locally adaptive (`la_model.slim`) and an overdominant (`od_model.slim`) scenario.\
Before running the model, check `run_model.sh` to ensure the right SLiM file is being called.\
The shell script `run_model`.sh\` is as follows:

```{bash}
#!/bin/bash
i=$1
cd data
mkdir ${i}
cd ${i}
/usr/local/bin/slim ../../la_model.slim # Change this to the SLiM model you wish to run.
for file in *.*; do
	mv ${file} ${i}_${file}
done
```

To run the model run `wrapper.sh` in the directory you wish the data to be output.

## After running the model: Data sorting and parsing

Prior to loading the data into R, SLiM output files should be parsed with the shell script `sort_output.sh`.\
Runs are sorted based on whether the model ran to completion, *i.e.* the inversion did not die out.

The shell script `sort_output.sh` is as follows:

```{bash}
#!/bin/bash
runs=$(ls -l data/ | wc -l)
mkdir data/full_runs
mkdir data/lost_runs
cd data

for i in $(seq $runs); do
#
	if [ -f ${i}/"${i}_lost_fitness.csv" ]; then
		cd lost_runs
		mv ../${i} ${i}
		cd ..
	else
		cd full_runs
		mv ../${i} ${i}
		cd ..
	fi
done
DIR=$(date +%Y%m%d%H%M)
mkdir "${DIR}"
cp full_runs ${DIR}/full_runs
cp lost_runs ${DIR}/lost_runs
tar --use-compress-program="pigz -k -p2" -cf ${DIR}.tar.gz ${DIR}
# -p is the number of processors to use
rm -r "${DIR}"
```

After sorting the runs, the R script `join_data.R` tidies the data. (Aside: This could be amalgamated with `plots.R` into one `analysis.Rmd` file that walks you through how we specifically generated our plots) The R script `join_data.R` is as follows:

```{r, echo=TRUE}
library(tidyverse)
setwd("inversion_model/")
files <- length(list.files("data_011223/full_runs"))
full_runs <- list.files("data_011223/full_runs")

# For joining SLiM output fitness and genotype data into a single file
for (i in 1:files) {
  run <- (full_runs[i])
  cat(run)
  setwd(file.path("data_011223/full_runs/",run))
  data <- read_delim(paste0(run,"_fitness.csv"),col_names=F) %>%
    rename(gen=X1,pop=X2)
  data <- data %>%
    pivot_longer(c(-gen,-pop), names_to = "sample",values_to = "fitness")
  genotypes <- read_delim(paste0(run,"_genotypes.csv"),col_names=F) %>%
    rename(gen=X1,pop=X2)
  genotypes <- genotypes %>%
    pivot_longer(c(-gen,-pop), names_to = "sample",values_to = "inv_genotype")
  joined_data <- data %>%
    inner_join(genotypes)
  write.csv(joined_data,paste0(run,".csv"), row.names = FALSE)
}

# For creating a single, massive file of all run data
setwd("data_011223/processed")
write.csv(joined_data,"all_data.csv", row.names = FALSE)
```

Make sure to replace the date with the one generated after you ran the model.
