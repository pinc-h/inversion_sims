---
title: "Analysis"
output: pdf_document
date: "2023-04-03"
echo = FALSE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

## Running the model

## After running the model: Data sorting and parsing

After running the SLiM model

Prior to running the analyses here, SLiM output files were parsed with the shell script `sort_output.sh`.\
Runs were sorted based on whether the model ran to completion, *i.e.* the inversion did not die out.

```{bash}
#!/bin/bash
runs=$(ls -l data/ | wc -l)
mkdir data/full_runs
mkdir data/lost_runs
cd data

for i in $(seq $runs); do
#
	if [ -f ${i}/"${i}_lost_fitness.csv" ]; then
		cd lost_runs
		mv ../${i} ${i}
		cd ..
	else
		cd full_runs
		mv ../${i} ${i}
		cd ..
	fi
done
DIR=$(date +%Y%m%d%H%M)
mkdir "${DIR}"
cp full_runs ${DIR}/full_runs
cp lost_runs ${DIR}/lost_runs
tar --use-compress-program="pigz -k -p2" -cf ${DIR}.tar.gz ${DIR}
# -p is the number of processors to use
rm -r "${DIR}"
```

The R script `join_data.R`  
```{r, echo=TRUE}
library(tidyverse)
setwd("inversion_model/")
files <- length(list.files("data_011223/full_runs"))
full_runs <- list.files("data_011223/full_runs")

# For joining SLiM output fitness and genotype data into a single file
for (i in 1:files) {
  run <- (full_runs[i])
  cat(run)
  setwd(file.path("data_011223/full_runs/",run))
  data <- read_delim(paste0(run,"_fitness.csv"),col_names=F) %>%
    rename(gen=X1,pop=X2)
  data <- data %>%
    pivot_longer(c(-gen,-pop), names_to = "sample",values_to = "fitness")
  genotypes <- read_delim(paste0(run,"_genotypes.csv"),col_names=F) %>%
    rename(gen=X1,pop=X2)
  genotypes <- genotypes %>%
    pivot_longer(c(-gen,-pop), names_to = "sample",values_to = "inv_genotype")
  joined_data <- data %>%
    inner_join(genotypes)
  write.csv(joined_data,paste0(run,".csv"), row.names = FALSE)
}

# For creating a single, massive file of all run data
setwd("data_011223/processed")
write.csv(joined_data,"all_data.csv", row.names = FALSE)
```

## Generating plots: Data analysis

You can also embed plots, for example:

```{r pressure, echo=TRUE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
